---
title: "p8105_hw6_hq2163_hanbo"
author: "Hanbo Qiu"
date: "November 19, 2018"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
  )
  
library(tidyverse)
library(ggridges)
theme_set(theme_bw() + theme(plot.title = element_text(hjust = 0.5)))
```

##Problem 1

**Import a dataset and make some alternation on some variables:**

```{r}
homicides = read_csv(file = "./homicide-data.csv") %>% 
   mutate(city_state = str_c(city, ", ", state),
        resolved = as.numeric(disposition == "Closed by arrest"),
        victim_age = as.numeric(victim_age),
        victim_race = ifelse(victim_race == "White", "white", "non-white"), 
        victim_race = relevel(factor(victim_race),ref = "white")) %>% 
   filter(!city_state %in% c("Dallas, TX", "Phoenix, AZ", "Kansas City, MO", "Tulsa, AL"))
```

Create a city_state variable (e.g. “Baltimore, MD”), and a binary variable indicating whether the homicide is solved. Omit cities Dallas, TX; Phoenix, AZ; and Kansas City, MO and Tulsa, AL. Modifiy victim_race to have categories white and  non-white, with white as the reference category. Modify victim_age as numeric.

**Fit the model of "Baltimore, MD" :**

```{r}
baltimore_df = homicides %>% 
  filter(city_state == "Baltimore, MD" )
fit_logistic = 
  glm(resolved ~ victim_age + victim_sex + victim_race, 
    data = baltimore_df, 
    family = binomial()) 

  confi_interval=confint(fit_logistic) %>% as.data.frame() %>% 
  tail(1) %>% 
  gather(key = CI, value = value ) %>% 
  mutate(CI_OR = exp(value))
  
  broom::tidy(fit_logistic) %>% 
  mutate(OR = exp(estimate)) %>% 
  tail(1) %>% 
  select(estimate, OR) %>% 
  knitr::kable(digits = 3)
```

We fitted a logistic regression with resolved vs unresolved as the outcome and victim age, sex and race as predictors for Baltimore, MD. The estimate for solving homicides comparing non-white victims to white victims keeping all other variables fixed is 0.441. The lower level confidence interval of the adjusted odds ratio of is `r round(confi_interval[[1,3]], digits = 3)`, the upper level confidence interval is `r round(confi_interval[[2,3]], digits = 3)`.

**Fit the model each of the cities :**

```{r}
nest_lm_res =
  homicides %>% 
  group_by(city_state) %>% 
  nest() %>% 
  mutate(models = map(data, ~glm(resolved ~ victim_age + victim_sex + victim_race, data = .x, family = binomial())),
         ci = map(.x=models, ~confint(.x)),
         or = map(models, broom::tidy),
         ci = map(ci, broom::tidy)) %>% 
  select(-data,-models) %>% 
  unnest() %>% 
  filter(term == "victim_racenon-white") %>% 
  select(city_state, or = estimate, ci_low = "X2.5..", ci_high = "X97.5..") %>% 
  mutate(or = exp(or), ci_low = exp(ci_low), ci_high = exp(ci_high))
```

**Create a plot that shows the estimated ORs and CIs for each city. Organize cities according to estimated OR, and comment on the plot:**

```{r}
nest_lm_res %>% 
  mutate(city_state = fct_reorder(city_state, or)) %>% 
  ggplot(aes(x = city_state, y = or)) + 
  geom_point() + 
  geom_errorbar(aes(ymin = ci_low, ymax = ci_high)) + 
  labs(
    title = "The estimated ORs and CIs for each city",
    x = "City",
    y = "The estimated ORs and CIs",
    caption = "Data from The Washington Post"
  ) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

This figure suggests a very wide range in odds ratio (and CI) for solving homicides comparing non-white victims to white victims.  -- Tampa, FL is noticeably high and, given the width of the CI, meaning that for every increasing non-white victims comparing to white victims, the OR for solving homicides is higest. 

##Problem 2

**Import a dataset and make some alternation on some variables:**

```{r}
birthweith = read_csv(file = "./birthweight.csv") 
  
```

